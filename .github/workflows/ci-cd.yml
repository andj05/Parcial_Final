name: ğŸš€ DevOps CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/hola-mundo-devops

jobs:
  # Job 1: Instalar dependencias y ejecutar pruebas
  test:
    runs-on: ubuntu-latest
    name: ğŸ“¦ Install & Test
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ“¦ Usar Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“š Instalar dependencias
        run: npm ci
        
      - name: ğŸ§ª Ejecutar pruebas unitarias
        run: npm test

      - name: ğŸ“Š Generar reporte de cobertura
        run: npm test -- --coverage || true

  # Job 2: Construir y subir imagen Docker
  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    name: ğŸ³ Build & Push Docker
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ğŸ” Login a Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Build y Push imagen
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ“¢ Resumen del build
        run: |
          echo "âœ… Imagen construida y subida exitosamente"
          echo "ğŸ“¦ Imagen: ${{ env.IMAGE_NAME }}:latest"
          echo "ğŸ”— Link: https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/hola-mundo-devops"

  # Job 3: Desplegar en producciÃ³n (Render)
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy a Render
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ”” Trigger Render Deploy
        run: |
          curl --request POST \
            --url "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
            --header "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            --header "Content-Type: application/json"

      - name: â³ Esperar a que Render procese
        run: sleep 30

      - name: âœ… Deploy completado
        run: |
          echo "âœ… Deploy enviado a Render"
          echo "ğŸŒ Tu aplicaciÃ³n se actualizarÃ¡ en breves momentos"
          echo "ğŸ“‹ Verifica el estado en: https://dashboard.render.com"

  # Job 4: NotificaciÃ³n de resultado
  notify:
    needs: [test, build-and-push, deploy]
    runs-on: ubuntu-latest
    name: ğŸ“¬ Notificaciones
    if: always()
    
    steps:
      - name: ğŸ“Š Resumen de Pipeline
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   ğŸš€ PIPELINE CI/CD COMPLETADO    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Tests:        ${{ needs.test.result }}"
          echo "âœ… Build/Push:   ${{ needs.build-and-push.result }}"
          echo "âœ… Deploy:       ${{ needs.deploy.result }}"
          echo ""
          echo "Commit: ${{ github.sha }}"
          echo "Rama:   ${{ github.ref }}"
          echo "Actor:  ${{ github.actor }}"